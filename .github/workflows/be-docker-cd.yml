name: Backend Prod Docker CD (Blue-Green)

on:
  push:
    branches: [ dev ]
    paths-ignore:
      - '**/README.md'
      - '**/.gitignore'

jobs:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ Build & Push  (GitHub-hosted)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    outputs:
      image:  ${{ steps.push.outputs.image }}
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle Build
        run: |
          ./gradlew clean build
          cp build/libs/newsum-0.0.1-SNAPSHOT.jar app.jar   # ë£¨íŠ¸ì— JAR

      # â€” AWS & ECR ë¡œê·¸ì¸ â€”
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:      ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:             ap-northeast-2

      - name: ECR Docker Login
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
          | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      # â€” Docker Build & Push â€”
      - name: Build & Push image
        id: push
        run: |
          IMAGE="${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPO }}:latest"
          docker build -t "$IMAGE" .
          docker push  "$IMAGE"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ Deploy (AZ-1, íƒ€ê¹ƒ ê²°ì • & ì¶œë ¥)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-az1:
    needs: build
    runs-on: [ self-hosted, linux, ec2-prod-runner ]   # EC2-1
    outputs:
      target: ${{ steps.decide.outputs.target }}

    steps:
      # AWS ë¡œê·¸ì¸ & ECR ë¡œê·¸ì¸
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ap-northeast-2

      - name: ECR Login
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
          | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      # Infisical .env
      - name: Fetch .env
        run: |
          curl -Ls https://${{ secrets.AWS_CLOUDFRONT_URL }}/tools/infisical-linux-amd64 -o infisical
          chmod +x infisical && sudo mv infisical /usr/local/bin/infisical
          infisical export \
            --env=${{ secrets.INFISICAL_ENV_PROD }} \
            --projectId=${{ secrets.INFISICAL_PROJECT_ID }} \
            --token=${{ secrets.INFISICAL_TOKEN_PROD }} \
            --format=dotenv \
            --domain=${{ secrets.INFISICAL_API_URL }} > /tmp/deploy.env

      # ðŸ” Blue/Green ê²°ì •(EC2 ë‚´ë¶€)
      - name: Decide target
        id: decide
        run: |
          if docker ps --format '{{.Names}}' | grep -q backend-blue; then
               echo "target=green" >> "$GITHUB_OUTPUT"
               echo "TARGET=green"  >> "$GITHUB_ENV"
          else echo "target=blue"  >> "$GITHUB_OUTPUT"
               echo "TARGET=blue"  >> "$GITHUB_ENV"; fi

      # ë°°í¬
      - name: Deploy to AZ-1
        run: |
          cd ${{ secrets.BACKEND_PATH_PROD }}
          cp /tmp/deploy.env .env

          docker compose -f docker-compose-${TARGET}.yml pull
          docker compose -f docker-compose-${TARGET}.yml up -d --remove-orphans

          rm -f .env

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Deploy (AZ-2, ë™ì¼ íƒ€ê¹ƒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-az2:
    needs: deploy-az1               # íƒ€ê¹ƒ ê°’ ë°›ì•„ì˜¤ê¸°
    runs-on: [ self-hosted, linux, ec2-prod-runner ]   # EC2-2
    env:
      TARGET: ${{ needs.deploy-az1.outputs.target }}

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ap-northeast-2

      - name: ECR Login
        run: |
          aws ecr get-login-password --region ap-northeast-2 \
          | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      - name: Fetch .env
        run: |
          curl -Ls https://${{ secrets.AWS_CLOUDFRONT_URL }}/tools/infisical-linux-amd64 -o infisical
          chmod +x infisical && sudo mv infisical /usr/local/bin/infisical
          infisical export \
            --env=${{ secrets.INFISICAL_ENV_PROD }} \
            --projectId=${{ secrets.INFISICAL_PROJECT_ID }} \
            --token=${{ secrets.INFISICAL_TOKEN_PROD }} \
            --format=dotenv \
            --domain=${{ secrets.INFISICAL_API_URL }} > /tmp/deploy.env

      - name: Deploy to AZ-2
        run: |
          cd ${{ secrets.BACKEND_PATH_PROD }}
          cp /tmp/deploy.env .env

          docker compose -f docker-compose-${TARGET}.yml pull
          docker compose -f docker-compose-${TARGET}.yml up -d --remove-orphans

          rm -f .env

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ Switch ALB Listener  (Blue â‡„ Green)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  switch-alb:
    needs: [ deploy-az2 ]
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ap-northeast-2

      - name: Pick TargetGroup ARN
        id: pick
        run: |
          if [ "${{ needs.deploy-az1.outputs.target }}" = "blue" ]; then
               echo "arn=${{ secrets.TG_BLUE_ARN }}"  >> "$GITHUB_OUTPUT"
          else echo "arn=${{ secrets.TG_GREEN_ARN }}" >> "$GITHUB_OUTPUT"; fi

      - name: Switch ALB Listener
        run: |
          aws elbv2 modify-listener \
            --listener-arn ${{ secrets.ALB_LISTENER_ARN }} \
            --default-actions Type=forward,TargetGroupArn=${{ steps.pick.outputs.arn }} \
            --region ap-northeast-2
